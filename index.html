<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma Minimalista Premium</title>
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Ícones) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }

        /* Animações e Transições */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        .slide-right { animation: slideRight 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideRight { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-[#FDFBF9] text-stone-700 flex items-center justify-center p-4 selection:bg-indigo-100 selection:text-indigo-800">

    <!-- App Container -->
    <div class="max-w-6xl w-full bg-[#FCFCFC] rounded-[2.5rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.06)] overflow-hidden flex flex-col md:flex-row min-h-[800px] border border-stone-100 relative">
        
        <!-- ESQUERDA: CALENDÁRIO & PERFIL -->
        <div class="w-full md:w-[380px] bg-[#FAFAFA] p-8 border-r border-stone-100 flex flex-col z-10 relative">
            
            <!-- Perfil do Usuário (Novo) -->
            <div class="mb-8 pb-6 border-b border-stone-100 slide-right">
                <div class="flex items-center gap-4 mb-2">
                    <div class="w-12 h-12 rounded-2xl bg-white border border-stone-100 flex items-center justify-center shadow-sm text-stone-300">
                        <i data-lucide="user" width="20"></i>
                    </div>
                    <div class="flex-1">
                        <input id="user-name-input" type="text" placeholder="Seu Nome" 
                            onchange="app.saveUserProfile()"
                            class="w-full bg-transparent border-none p-0 text-lg font-bold text-stone-800 placeholder-stone-300 focus:ring-0 focus:outline-none transition-colors hover:placeholder-stone-400"
                        >
                        <div class="flex items-center gap-1.5 text-xs text-stone-400">
                            <i data-lucide="graduation-cap" width="12"></i>
                            <input id="user-course-input" type="text" placeholder="Curso dos Sonhos..." 
                                onchange="app.saveUserProfile()"
                                class="w-full bg-transparent border-none p-0 text-xs font-medium text-stone-500 placeholder-stone-300 focus:ring-0 focus:outline-none"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Header Mês -->
            <div class="flex items-center justify-between mb-8 pl-2">
                <div>
                    <h2 id="current-month-display" class="text-xl font-bold text-stone-800 tracking-tight capitalize">Janeiro</h2>
                    <p id="current-year-display" class="text-sm text-stone-400 font-medium">2024</p>
                </div>
                <div class="flex gap-1">
                    <button onclick="app.changeMonth(-1)" class="p-2 hover:bg-white rounded-full text-stone-400 hover:text-stone-800 transition-all hover:shadow-sm">
                        <i data-lucide="chevron-left" width="18"></i>
                    </button>
                    <button onclick="app.changeMonth(1)" class="p-2 hover:bg-white rounded-full text-stone-400 hover:text-stone-800 transition-all hover:shadow-sm">
                        <i data-lucide="chevron-right" width="18"></i>
                    </button>
                </div>
            </div>

            <!-- Grid Calendário -->
            <div class="mb-8">
                <div class="grid grid-cols-7 mb-4 text-[10px] font-bold tracking-widest text-stone-400 uppercase text-center">
                    <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-y-3 place-items-center">
                    <!-- Dias gerados via JS -->
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="mt-auto space-y-3">
                <button onclick="app.toggleModal(true)" class="w-full py-4 px-5 bg-white border border-stone-100 hover:border-indigo-100 rounded-2xl flex items-center gap-4 group transition-all duration-300 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.03)] hover:shadow-[0_8px_25px_-4px_rgba(99,102,241,0.1)] hover:-translate-y-0.5">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-50 to-white border border-indigo-50 text-indigo-500 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm">
                        <i data-lucide="sparkles" width="18"></i>
                    </div>
                    <div class="text-left">
                        <p class="text-sm font-bold text-stone-700 group-hover:text-indigo-700 transition-colors">Gerador Inteligente</p>
                        <p class="text-xs text-stone-400 font-medium">Configurar rotina & metas</p>
                    </div>
                </button>
                
                <button onclick="app.toggleTutorial(true)" class="w-full py-3 px-5 bg-transparent border border-transparent hover:bg-stone-100 rounded-xl flex items-center justify-center gap-2 text-stone-400 hover:text-stone-600 transition-all text-xs font-semibold">
                    <i data-lucide="help-circle" width="14"></i>
                    Como funciona?
                </button>
            </div>
        </div>

        <!-- DIREITA: AGENDA -->
        <div class="flex-1 p-8 md:p-12 flex flex-col relative bg-white/50">
            <!-- Decorativo -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-b from-stone-50 to-transparent opacity-50 -z-10 rounded-bl-[100px]"></div>

            <!-- Header Dia -->
            <header class="flex justify-between items-start mb-12">
                <div class="flex flex-col">
                    <h1 id="selected-day-number" class="text-6xl font-light text-stone-800 tracking-tighter leading-none mb-1">01</h1>
                    <div class="flex items-center gap-2">
                        <p id="selected-day-month" class="text-lg font-medium text-stone-400 capitalize">Janeiro</p>
                        <span class="w-1 h-1 rounded-full bg-stone-300"></span>
                        <p id="selected-day-weekday" class="text-lg font-medium text-stone-400 capitalize">Segunda-feira</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="today-btn" onclick="app.goToToday()" class="hidden px-4 py-2 bg-white border border-stone-100 text-stone-500 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-stone-50 transition-colors shadow-sm">
                        Hoje
                    </button>
                    <!-- Botão Day Off -->
                    <button id="dayoff-btn" onclick="app.toggleDayOff()" class="px-4 py-2 bg-rose-50 border border-rose-100 text-rose-500 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-rose-100 transition-colors shadow-sm flex items-center gap-2 group">
                        <i data-lucide="coffee" width="14" class="group-hover:rotate-12 transition-transform"></i>
                        Day Off
                    </button>
                </div>
            </header>

            <!-- Lista de Tarefas -->
            <div id="tasks-list" class="flex-1 overflow-y-auto pr-3 custom-scrollbar space-y-4 relative">
                <!-- Conteúdo gerado via JS -->
            </div>

            <!-- Input Flutuante (Escondido se for Day Off) -->
            <div id="add-task-container" class="mt-6 pt-4">
                <form onsubmit="app.addTask(event)" class="relative group">
                    <div class="flex items-center gap-3 bg-white border border-stone-200 p-2 rounded-2xl shadow-sm transition-all duration-300 focus-within:ring-4 focus-within:ring-stone-50 focus-within:border-stone-300 focus-within:shadow-lg">
                        <!-- Color Picker -->
                        <div class="relative group/picker">
                            <div id="current-color-preview" class="w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center cursor-pointer transition-transform active:scale-95">
                                <div class="w-3 h-3 rounded-full bg-indigo-600"></div>
                            </div>
                            <div id="color-options" class="absolute bottom-full left-0 mb-3 p-1.5 bg-white border border-stone-100 shadow-xl rounded-xl flex gap-1.5 hidden group-hover/picker:flex z-20 animate-[slideUp_0.2s_ease-out]">
                                <!-- Cores geradas via JS -->
                            </div>
                        </div>

                        <input id="new-task-input" type="text" placeholder="Adicionar nova matéria..." class="flex-1 bg-transparent text-stone-700 placeholder-stone-400 focus:outline-none font-medium h-10 px-2">
                        
                        <button type="submit" class="w-10 h-10 flex items-center justify-center bg-stone-900 text-white rounded-xl hover:bg-black transition-all shadow-md active:scale-95">
                            <i data-lucide="plus" width="20"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE ROTINA -->
    <div id="routine-modal" class="fixed inset-0 z-50 bg-stone-900/10 backdrop-blur-sm hidden items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-3xl rounded-[2rem] shadow-2xl shadow-stone-300 overflow-hidden flex flex-col max-h-[90vh] border border-stone-100 slide-up">
            <!-- Header -->
            <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50/30">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-stone-100">
                        <i data-lucide="settings" width="20" class="text-stone-600"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-stone-800">Gerador de Rotina</h2>
                        <p class="text-xs text-stone-400 font-medium mt-0.5">Automatize seu planejamento</p>
                    </div>
                </div>
                <button onclick="app.toggleModal(false)" class="p-2 hover:bg-stone-100 rounded-full text-stone-400 hover:text-stone-600 transition-colors">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-8 space-y-10 custom-scrollbar">
                <!-- 1. Métodos -->
                <section>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-violet-600 mb-4 flex items-center gap-2">
                        <i data-lucide="layers" width="14"></i> Métodos de Retenção
                    </h3>
                    <div class="grid sm:grid-cols-2 gap-4" id="methods-container"></div>
                </section>
                <!-- 2. Prioridades -->
                <section>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-amber-600 mb-4 flex items-center gap-2">
                        <i data-lucide="alert-circle" width="14"></i> Matérias Prioritárias (Foco)
                    </h3>
                    <div class="bg-stone-50/50 rounded-2xl p-5 border border-stone-100">
                        <div class="flex flex-wrap gap-2 mb-6" id="priorities-container"></div>
                        <button onclick="app.generateSmartDistribution()" class="w-full py-3.5 bg-gradient-to-r from-stone-900 to-stone-800 hover:to-black text-white rounded-xl font-bold text-sm shadow-lg shadow-stone-200 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                            <i data-lucide="zap" width="16" class="text-yellow-400 fill-yellow-400"></i>
                            Gerar Rotina Inteligente
                        </button>
                    </div>
                </section>
                <hr class="border-stone-100">
                <!-- 3. Manual -->
                <section class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold uppercase tracking-wider text-stone-400">Ajuste Fino (Manual)</label>
                        <button onclick="app.applyPreset('ENEM')" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-colors">
                            Carregar Modelo ENEM
                        </button>
                    </div>
                    <div id="weekly-distribution" class="space-y-2"></div>
                </section>
            </div>
            <!-- Footer -->
            <div class="p-6 border-t border-stone-100 bg-stone-50/50 flex justify-end gap-3">
                <button onclick="app.toggleModal(false)" class="px-6 py-3 rounded-xl text-stone-500 font-bold text-sm hover:bg-white hover:shadow-sm transition-all">
                    Fechar
                </button>
                <button onclick="app.generateMonthSchedule()" class="px-8 py-3 bg-stone-900 text-white rounded-xl font-bold text-sm shadow-xl shadow-stone-200 hover:bg-black hover:scale-[1.02] active:scale-95 transition-all flex items-center gap-2">
                    <i data-lucide="check" width="16"></i>
                    Aplicar ao Calendário
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL TUTORIAL (Novo) -->
    <div id="tutorial-modal" class="fixed inset-0 z-50 bg-stone-900/20 backdrop-blur-sm hidden items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl shadow-stone-400 overflow-hidden border border-stone-100 slide-up p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                    <i data-lucide="book-open" width="32"></i>
                </div>
                <h2 class="text-2xl font-bold text-stone-800">Como usar seu Cronograma</h2>
                <p class="text-stone-400 mt-1">Três passos para a produtividade máxima</p>
            </div>

            <div class="space-y-6">
                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center font-bold text-stone-600 shrink-0">1</div>
                    <div>
                        <h3 class="font-bold text-stone-700">Configure seu Perfil</h3>
                        <p class="text-sm text-stone-500 leading-relaxed">No topo esquerdo, digite seu nome e o curso desejado. Isso personaliza sua experiência.</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center font-bold text-stone-600 shrink-0">2</div>
                    <div>
                        <h3 class="font-bold text-stone-700">Gere a Rotina</h3>
                        <p class="text-sm text-stone-500 leading-relaxed">Clique no botão "Gerador Inteligente". Escolha matérias prioritárias e o site distribuirá automaticamente durante sua semana.</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center font-bold text-stone-600 shrink-0">3</div>
                    <div>
                        <h3 class="font-bold text-stone-700">Respeite seus Limites</h3>
                        <p class="text-sm text-stone-500 leading-relaxed">Não conseguiu estudar? Clique em <strong>"Day Off"</strong>. O descanso é parte essencial do aprendizado.</p>
                    </div>
                </div>
            </div>

            <button onclick="app.toggleTutorial(false)" class="w-full mt-8 py-4 bg-stone-900 text-white rounded-2xl font-bold hover:bg-black transition-all">
                Entendi, vamos começar!
            </button>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CONSTANTES & DADOS ---
        const COLORS = [
            { id: 0, bg: 'bg-stone-100', text: 'text-stone-600', border: 'border-stone-200', dot: 'bg-stone-400', rawText: 'stone-600' },
            { id: 1, bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-100', dot: 'bg-indigo-500', rawText: 'indigo-600' },
            { id: 2, bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100', dot: 'bg-emerald-500', rawText: 'emerald-600' },
            { id: 3, bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-100', dot: 'bg-rose-500', rawText: 'rose-600' },
            { id: 4, bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-100', dot: 'bg-amber-500', rawText: 'amber-600' },
            { id: 5, bg: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-100', dot: 'bg-violet-500', rawText: 'violet-600' },
        ];

        const COMMON_SUBJECTS = ['Matemática', 'Física', 'Química', 'Biologia', 'História', 'Geografia', 'Filosofia', 'Sociologia', 'Português', 'Literatura', 'Redação', 'Inglês'];
        const STUDY_PRESETS = { ENEM: { subjects: { 1: 'Português, Redação, Literatura', 2: 'Matemática, Física', 3: 'História, Geografia, Sociologia', 4: 'Química, Biologia', 5: 'Filosofia, Inglês, Artes' } } };
        const MONTHS = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const WEEKDAYS = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

        // --- CLASSE PRINCIPAL ---
        class SchedulerApp {
            constructor() {
                // Estado
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.tasks = JSON.parse(localStorage.getItem('min_calendar_tasks_v8')) || {};
                this.routineConfig = JSON.parse(localStorage.getItem('min_calendar_routine_v8')) || {
                    activeDays: [1, 2, 3, 4, 5],
                    subjects: { 0: '', 1: '', 2: '', 3: '', 4: '', 5: '', 6: '' },
                    priorities: [],
                    includeAnki: false,
                    includeReview: false
                };
                this.userProfile = JSON.parse(localStorage.getItem('min_calendar_profile_v8')) || { name: '', course: '' };
                this.selectedColor = 1;

                this.init();
            }

            init() {
                this.renderCalendar();
                this.renderDayHeader();
                this.renderTasks();
                this.renderColorPicker();
                this.renderRoutineModal();
                this.loadUserProfile();
                lucide.createIcons();
            }

            save() {
                localStorage.setItem('min_calendar_tasks_v8', JSON.stringify(this.tasks));
                localStorage.setItem('min_calendar_routine_v8', JSON.stringify(this.routineConfig));
            }

            saveUserProfile() {
                this.userProfile.name = document.getElementById('user-name-input').value;
                this.userProfile.course = document.getElementById('user-course-input').value;
                localStorage.setItem('min_calendar_profile_v8', JSON.stringify(this.userProfile));
            }

            loadUserProfile() {
                document.getElementById('user-name-input').value = this.userProfile.name;
                document.getElementById('user-course-input').value = this.userProfile.course;
            }

            formatDateKey(date) { return date.toISOString().split('T')[0]; }
            isSameDay(d1, d2) { return d1.toDateString() === d2.toDateString(); }

            changeMonth(offset) {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + offset, 1);
                this.renderCalendar();
                lucide.createIcons();
            }

            selectDay(day) {
                this.selectedDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
                this.renderCalendar();
                this.renderDayHeader();
                this.renderTasks();
                lucide.createIcons();
            }

            goToToday() {
                this.selectedDate = new Date();
                this.currentDate = new Date();
                this.init();
            }

            toggleDayOff() {
                const dateKey = this.formatDateKey(this.selectedDate);
                // Verifica se já é day off
                const isOff = this.tasks[dateKey] && this.tasks[dateKey][0] && this.tasks[dateKey][0].id === 'day-off';
                
                if (isOff) {
                    // Remover Day Off (Voltar ao normal vazio)
                    this.tasks[dateKey] = [];
                } else {
                    // Ativar Day Off (Sobrescreve tarefas)
                    if (confirm('Isso removerá as tarefas de hoje para marcar como descanso. Confirmar?')) {
                        this.tasks[dateKey] = [{ id: 'day-off', title: 'Day Off', isDayOff: true }];
                    } else {
                        return;
                    }
                }
                this.save();
                this.renderTasks();
                this.renderCalendar();
                lucide.createIcons();
            }

            addTask(e) {
                e.preventDefault();
                const input = document.getElementById('new-task-input');
                const title = input.value.trim();
                if (!title) return;

                const dateKey = this.formatDateKey(this.selectedDate);
                
                // Se era Day Off, limpa antes
                if (this.tasks[dateKey] && this.tasks[dateKey][0] && this.tasks[dateKey][0].id === 'day-off') {
                    this.tasks[dateKey] = [];
                }

                const newTask = { id: Date.now(), title: title, colorIndex: this.selectedColor, completed: false, studiedTime: '' };
                if (!this.tasks[dateKey]) this.tasks[dateKey] = [];
                this.tasks[dateKey].push(newTask);
                
                input.value = '';
                this.save();
                this.renderTasks();
                this.renderCalendar();
                lucide.createIcons();
            }

            toggleTask(id) {
                const dateKey = this.formatDateKey(this.selectedDate);
                if (this.tasks[dateKey]) {
                    this.tasks[dateKey] = this.tasks[dateKey].map(t => t.id === id ? { ...t, completed: !t.completed } : t);
                    this.save();
                    this.renderTasks();
                    lucide.createIcons();
                }
            }

            deleteTask(id) {
                const dateKey = this.formatDateKey(this.selectedDate);
                if (this.tasks[dateKey]) {
                    this.tasks[dateKey] = this.tasks[dateKey].filter(t => t.id !== id);
                    this.save();
                    this.renderTasks();
                    this.renderCalendar();
                    lucide.createIcons();
                }
            }

            updateStudiedTime(id, value) {
                const dateKey = this.formatDateKey(this.selectedDate);
                if (this.tasks[dateKey]) {
                    this.tasks[dateKey] = this.tasks[dateKey].map(t => t.id === id ? { ...t, studiedTime: value } : t);
                    this.save();
                }
            }

            selectColor(index) {
                this.selectedColor = index;
                this.renderColorPicker();
            }

            toggleModal(show) {
                const modal = document.getElementById('routine-modal');
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
                if(show) this.renderRoutineModal();
                lucide.createIcons();
            }

            toggleTutorial(show) {
                const modal = document.getElementById('tutorial-modal');
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
                lucide.createIcons();
            }

            // ... Métodos de Rotina (toggleConfigOption, togglePriority, etc. iguais ao anterior) ...
            toggleConfigOption(key) { this.routineConfig[key] = !this.routineConfig[key]; this.save(); this.renderRoutineModal(); lucide.createIcons(); }
            togglePriority(subject) { const idx = this.routineConfig.priorities.indexOf(subject); if(idx>-1)this.routineConfig.priorities.splice(idx,1); else this.routineConfig.priorities.push(subject); this.save(); this.renderRoutineModal(); }
            toggleRoutineDay(dayIdx) { const idx = this.routineConfig.activeDays.indexOf(dayIdx); if(idx>-1)this.routineConfig.activeDays.splice(idx,1); else this.routineConfig.activeDays.push(dayIdx); this.routineConfig.activeDays.sort(); this.save(); this.renderRoutineModal(); }
            updateRoutineSubject(dayIdx, value) { this.routineConfig.subjects[dayIdx] = value; this.save(); }
            applyPreset(key) { this.routineConfig.activeDays = [1,2,3,4,5]; this.routineConfig.subjects = {...this.routineConfig.subjects, ...STUDY_PRESETS[key].subjects}; this.save(); this.renderRoutineModal(); }

            generateSmartDistribution() {
                const { priorities, activeDays } = this.routineConfig;
                if (activeDays.length === 0) return alert("Selecione dias da semana.");
                let pool = [];
                priorities.forEach(s => { pool.push(s); pool.push(s); });
                COMMON_SUBJECTS.filter(s => !priorities.includes(s)).forEach(s => pool.push(s));
                pool.sort(() => Math.random() - 0.5);
                const buckets = {};
                activeDays.forEach(d => buckets[d] = []);
                const canAdd = (day, subj) => !buckets[day].includes(subj) && buckets[day].length < 3;
                let queue = [...pool];
                while (queue.length > 0) {
                    const subj = queue.shift();
                    const sortedDays = [...activeDays].sort((a,b) => buckets[a].length - buckets[b].length);
                    for (const day of sortedDays) { if (canAdd(day, subj)) { buckets[day].push(subj); break; } }
                    if (activeDays.every(d => buckets[d].length >= 3)) break;
                }
                activeDays.forEach(d => this.routineConfig.subjects[d] = buckets[d].join(', '));
                this.save();
                this.renderRoutineModal();
            }

            generateMonthSchedule() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let newTasks = { ...this.tasks };

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const wDay = date.getDay();
                    const key = this.formatDateKey(date);
                    // Preserva Day Off se já existir e o usuário não quiser sobrescrever (aqui sobrescrevemos para aplicar nova rotina)
                    const dayTasks = [];

                    if (this.routineConfig.includeAnki && this.routineConfig.activeDays.includes(wDay)) 
                        dayTasks.push({ id: Math.random(), title: "Anki / Flashcards", colorIndex: 5, completed: false, studiedTime: '' });
                    
                    if (this.routineConfig.includeReview && wDay === 6)
                        dayTasks.push({ id: Math.random(), title: "Revisão Semanal", colorIndex: 4, completed: false, studiedTime: '' });

                    if (this.routineConfig.activeDays.includes(wDay) && this.routineConfig.subjects[wDay]?.trim()) {
                        this.routineConfig.subjects[wDay].split(',').filter(s=>s.trim()).forEach((sub, i) => {
                            dayTasks.push({ id: Math.random(), title: sub.trim(), colorIndex: (i + 1) % 4, completed: false, studiedTime: '' });
                        });
                    }

                    if (dayTasks.length > 0) {
                        const existing = newTasks[key] || [];
                        // Se for Day Off, não mexe? Ou reseta? Vamos resetar para aplicar a nova rotina.
                        const existingTitles = new Set(existing.map(t => t.title));
                        const unique = dayTasks.filter(t => !existingTitles.has(t.title));
                        let ordered = existing[0]?.id === 'day-off' ? [] : [...existing]; // Remove day-off se gerar nova rotina em cima
                        
                        const anki = unique.find(t => t.title.includes("Anki"));
                        const rev = unique.find(t => t.title.includes("Revisão"));
                        const others = unique.filter(t => t !== anki && t !== rev);
                        if (anki) ordered.push(anki);
                        ordered.push(...others);
                        if (rev) ordered.push(rev);
                        newTasks[key] = ordered;
                    }
                }
                this.tasks = newTasks;
                this.save();
                this.toggleModal(false);
                this.renderCalendar();
                this.renderTasks();
                lucide.createIcons();
            }

            // --- RENDERS ---
            renderCalendar() {
                document.getElementById('current-month-display').textContent = MONTHS[this.currentDate.getMonth()];
                document.getElementById('current-year-display').textContent = this.currentDate.getFullYear();
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateKey = this.formatDateKey(date);
                    const isSelected = this.isSameDay(date, this.selectedDate);
                    const isToday = this.isSameDay(date, new Date());
                    
                    const tasks = this.tasks[dateKey] || [];
                    const hasTask = tasks.length > 0;
                    const isDayOff = hasTask && tasks[0].id === 'day-off';
                    
                    const wDay = date.getDay();
                    const isStudyDay = this.routineConfig.activeDays.includes(wDay) || (this.routineConfig.includeReview && wDay === 6);

                    let classes = "w-9 h-9 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-300 relative group ";
                    if (isSelected) {
                        classes += "bg-stone-800 text-white shadow-lg shadow-stone-800/30 scale-110";
                    } else {
                        classes += "text-stone-500 hover:bg-white hover:shadow-md hover:text-stone-800 ";
                        if (isToday) classes += "text-indigo-600 font-bold bg-indigo-50 ";
                        if (isStudyDay && !hasTask) classes += "ring-1 ring-stone-100 bg-white";
                    }

                    // Dots Logic
                    let dot = '';
                    if (isDayOff) dot = `<div class="absolute -bottom-1 w-1 h-1 bg-rose-400 rounded-full"></div>`;
                    else if (hasTask && !isSelected) dot = `<div class="absolute -bottom-1 w-1 h-1 bg-stone-400 rounded-full"></div>`;

                    const btn = document.createElement('button');
                    btn.className = classes;
                    btn.onclick = () => this.selectDay(day);
                    btn.innerHTML = `${day}${dot}`;
                    grid.appendChild(btn);
                }
            }

            renderDayHeader() {
                document.getElementById('selected-day-number').textContent = this.selectedDate.getDate().toString().padStart(2, '0');
                document.getElementById('selected-day-month').textContent = MONTHS[this.selectedDate.getMonth()];
                document.getElementById('selected-day-weekday').textContent = WEEKDAYS[this.selectedDate.getDay()];
                document.getElementById('today-btn').classList.toggle('hidden', this.isSameDay(this.selectedDate, new Date()));
            }

            renderTasks() {
                const list = document.getElementById('tasks-list');
                const addContainer = document.getElementById('add-task-container');
                const dateKey = this.formatDateKey(this.selectedDate);
                const dayTasks = this.tasks[dateKey] || [];
                
                // Verifica Day Off
                const isDayOff = dayTasks.length > 0 && dayTasks[0].id === 'day-off';
                
                // Botão de Day Off Estado Visual
                const dayOffBtn = document.getElementById('dayoff-btn');
                if (isDayOff) {
                    dayOffBtn.classList.replace('bg-rose-50', 'bg-rose-500');
                    dayOffBtn.classList.replace('text-rose-500', 'text-white');
                    addContainer.classList.add('hidden'); // Esconde input se for day off
                } else {
                    dayOffBtn.classList.replace('bg-rose-500', 'bg-rose-50');
                    dayOffBtn.classList.replace('text-white', 'text-rose-500');
                    addContainer.classList.remove('hidden');
                }

                list.innerHTML = '';

                // Visual Day Off
                if (isDayOff) {
                    list.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-rose-300 select-none pb-20 fade-in">
                            <div class="w-24 h-24 bg-rose-50 rounded-full flex items-center justify-center mb-6 shadow-inner animate-pulse">
                                <i data-lucide="coffee" width="32" class="opacity-40"></i>
                            </div>
                            <p class="text-xl font-bold text-rose-400">Day Off</p>
                            <p class="text-sm text-rose-300/80 mt-2 max-w-[200px] text-center">Recarregue as energias. O descanso também faz parte do processo.</p>
                        </div>
                    `;
                    return;
                }

                // Lista Vazia
                if (dayTasks.length === 0) {
                    list.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-stone-300 select-none pb-20">
                            <div class="w-24 h-24 bg-stone-50 rounded-full flex items-center justify-center mb-6 shadow-inner">
                                <i data-lucide="calendar" width="32" class="opacity-20"></i>
                            </div>
                            <p class="text-xl font-light text-stone-400">Dia livre</p>
                            <p class="text-sm text-stone-300 mt-2">Nenhuma atividade planejada.</p>
                        </div>
                    `;
                    return;
                }

                // Renderiza Tarefas
                dayTasks.forEach(task => {
                    const theme = COLORS[task.colorIndex || 0];
                    const completedClass = task.completed ? 'bg-stone-50/50 border-stone-100 opacity-60' : 'bg-white border-stone-100 hover:border-stone-200 shadow-[0_2px_15px_-4px_rgba(0,0,0,0.02)] hover:shadow-[0_8px_30px_-8px_rgba(0,0,0,0.06)] hover:-translate-y-0.5';
                    const checkClass = task.completed ? 'bg-stone-800 border-stone-800 text-white scale-90' : 'border-stone-200 text-transparent hover:border-stone-400';
                    const textClass = task.completed ? 'text-stone-400 line-through decoration-stone-300' : 'text-stone-700';
                    
                    const el = document.createElement('div');
                    el.className = `group relative flex items-center gap-5 p-5 rounded-[1.2rem] border transition-all duration-300 ${completedClass}`;
                    
                    el.innerHTML = `
                        <button onclick="app.toggleTask(${task.id})" class="flex-shrink-0 w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all duration-300 ${checkClass}">
                            <i data-lucide="check" width="14" stroke-width="3"></i>
                        </button>
                        <div class="flex-1 min-w-0 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                            <p class="font-medium text-lg truncate transition-all ${textClass}">${task.title}</p>
                            <div class="flex items-center gap-2 ml-auto">
                                <div class="group/input flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all duration-300 ${task.completed ? 'bg-transparent border-transparent' : 'bg-stone-50/50 border-stone-100 focus-within:bg-white focus-within:border-stone-300 focus-within:shadow-sm'}">
                                    <i data-lucide="timer" width="13" class="text-stone-300 group-focus-within/input:text-stone-500"></i>
                                    <input type="text" placeholder="Tempo" value="${task.studiedTime}" 
                                        oninput="app.updateStudiedTime(${task.id}, this.value)"
                                        onclick="event.stopPropagation()"
                                        class="bg-transparent text-xs font-semibold text-stone-600 placeholder-stone-300 focus:outline-none w-16 text-right">
                                </div>
                                <div class="w-2 h-2 rounded-full ${theme.dot}"></div>
                            </div>
                        </div>
                        <button onclick="app.deleteTask(${task.id})" class="absolute right-2 top-2 sm:static opacity-0 group-hover:opacity-100 p-2 text-stone-300 hover:text-rose-400 transition-all hover:bg-rose-50 rounded-lg">
                            <i data-lucide="trash-2" width="16"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            }

            renderColorPicker() {
                const preview = document.getElementById('current-color-preview');
                const theme = COLORS[this.selectedColor];
                preview.className = `w-10 h-10 rounded-xl ${theme.bg} border ${theme.border} flex items-center justify-center cursor-pointer transition-transform active:scale-95`;
                preview.innerHTML = `<div class="w-3 h-3 rounded-full ${theme.dot}"></div>`;
                const opts = document.getElementById('color-options');
                opts.innerHTML = '';
                COLORS.forEach((c, i) => {
                    const ring = this.selectedColor === i ? `ring-2 ring-offset-1 ring-stone-300` : '';
                    const div = document.createElement('div');
                    div.className = `w-6 h-6 rounded-full cursor-pointer ${c.bg} border ${c.border} hover:scale-110 transition-transform ${ring}`;
                    div.onclick = () => this.selectColor(i);
                    opts.appendChild(div);
                });
            }

            renderRoutineModal() {
                const methodsContainer = document.getElementById('methods-container');
                methodsContainer.innerHTML = '';
                [{ key: 'includeAnki', label: 'Anki Diário', sub: 'Flashcards todo dia', icon: 'layers', color: 'violet' },
                 { key: 'includeReview', label: 'Revisão Semanal', sub: 'Sábados de revisão', icon: 'repeat', color: 'amber' }
                ].forEach(m => {
                    const active = this.routineConfig[m.key];
                    const activeClass = active ? `bg-${m.color}-50 border-${m.color}-200` : 'bg-white border-stone-100 hover:border-stone-200 hover:shadow-sm';
                    const iconBg = active ? `bg-${m.color}-500 text-white shadow-md` : 'bg-stone-100 text-stone-400';
                    const textClass = active ? `text-${m.color}-900` : 'text-stone-700';
                    const btn = document.createElement('button');
                    btn.className = `flex items-center gap-4 p-4 rounded-2xl border transition-all text-left group ${activeClass}`;
                    btn.onclick = () => this.toggleConfigOption(m.key);
                    btn.innerHTML = `<div class="w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${iconBg}"><i data-lucide="${active ? 'check' : m.icon}" width="16"></i></div><div><span class="font-bold block text-sm ${textClass}">${m.label}</span><span class="text-xs text-stone-400">${m.sub}</span></div>`;
                    methodsContainer.appendChild(btn);
                });

                const prioritiesContainer = document.getElementById('priorities-container');
                prioritiesContainer.innerHTML = '';
                COMMON_SUBJECTS.forEach(sub => {
                    const active = this.routineConfig.priorities.includes(sub);
                    const btn = document.createElement('button');
                    btn.className = `px-3 py-1.5 rounded-lg text-xs font-semibold transition-all border ${active ? 'bg-amber-100 text-amber-800 border-amber-200 shadow-sm' : 'bg-white text-stone-500 border-stone-200 hover:border-amber-200 hover:text-stone-700'}`;
                    btn.onclick = () => this.togglePriority(sub);
                    btn.textContent = sub;
                    prioritiesContainer.appendChild(btn);
                });

                const weekContainer = document.getElementById('weekly-distribution');
                weekContainer.innerHTML = '';
                WEEKDAYS.forEach((dayName, idx) => {
                    const isActive = this.routineConfig.activeDays.includes(idx);
                    const containerClass = isActive ? 'border-indigo-100 bg-indigo-50/30' : 'border-stone-100 bg-white opacity-60';
                    const btnClass = isActive ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-stone-100 text-stone-400 hover:bg-stone-200';
                    const el = document.createElement('div');
                    el.className = `group border rounded-2xl p-1 transition-all duration-300 ${containerClass}`;
                    let contentRight = isActive ? `<input type="text" placeholder="Matérias..." value="${this.routineConfig.subjects[idx] || ''}" onchange="app.updateRoutineSubject(${idx}, this.value)" class="w-full bg-transparent border-b border-transparent focus:border-indigo-200 px-2 py-1 text-sm text-stone-700 placeholder-indigo-200/50 focus:outline-none transition-colors">` : `<div class="text-xs text-stone-300 px-2 cursor-pointer select-none" onclick="app.toggleRoutineDay(${idx})">Dia de descanso</div>`;
                    el.innerHTML = `<div class="flex items-center gap-3 p-2"><button onclick="app.toggleRoutineDay(${idx})" class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 transition-all font-bold text-xs uppercase ${btnClass}">${dayName.substring(0, 3)}</button><div class="flex-1">${contentRight}</div></div>`;
                    weekContainer.appendChild(el);
                });
            }
        }
        const app = new SchedulerApp();
    </script>
</body>
</html>
